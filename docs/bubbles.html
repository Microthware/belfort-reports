<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>bubbles — Report</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b0f14;--card:#11161d;--muted:#8ea0b3;--text:#e7eef7;--green:#16a34a;--red:#dc2626;--border:#223142;--barbg:#2c3238}
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:28px auto 20px;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;margin-bottom:12px}
    h1{font-size:22px;margin:0;margin-bottom: 8px;}
    .updated{color:var(--muted);font-size:12px}
    header .updated{display:none}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
    .section-title{font-size:14px;font-weight:700;margin:6px 0 10px;letter-spacing:.3px;color:#cfe1f7}
    .muted{color:var(--muted);font-size:12px}
    .value{font-size:20px;font-weight:700}
    .donut{display:flex;align-items:center;gap:12px}
    .pie{--p:50%;width:48px;height:48px;border-radius:50%;background:conic-gradient(var(--green) var(--p),var(--red) 0);-webkit-mask:radial-gradient(farthest-side,#0000 58%,#000 60%);mask:radial-gradient(farthest-side,#0000 58%,#000 60%);box-shadow:0 0 0 1px var(--border) inset}
    .winrate-num{font-size:18px;font-weight:800}
    .bar-block{display:grid;gap:8px}
    .hbar{background:var(--barbg);height:12px;border-radius:6px;overflow:hidden;position:relative}
    .hbar .fill.win{background:var(--green);height:100%;width:0}
    .hbar .fill.loss{background:var(--red);height:100%;width:0}
    .legend{display:flex;gap:12px;margin-top:4px;color:var(--muted);font-size:12px;align-items:center;flex-wrap:wrap}
    .legend .chip{width:10px;height:10px;border-radius:3px;display:inline-block;margin-right:6px}
    table{width:100%;border-collapse:collapse}
    thead th{text-align:left;font-weight:600;font-size:13px;color:var(--muted);padding:10px 12px;background:rgba(255,255,255,.02);border-bottom:1px solid var(--border)}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
    .money.up{color:var(--green);font-weight:600}
    .money.down{color:var(--red);font-weight:600}
    .pct.up{color:var(--green);font-weight:600}
    .pct.down{color:var(--red);font-weight:600}
    .note{color:var(--muted)}
    details{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:0}
    details>summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:700}
    details>summary::-webkit-details-marker{display:none}
    details .inner{padding:0 14px 14px}
    pre{white-space:pre-wrap;word-break:break-word}
    /* Balance chart container ensures no overflow */
    #balanceWrap{height:160px; position: relative;}
    #spark{width:100%; height:160px; display:block;}
    .footer-updated{position:fixed;right:12px;bottom:10px;color:var(--muted);font-size:12px}
    .back{display:inline-block;margin-bottom:8px;color:#9ecbff;text-decoration:none}
    .back:hover{text-decoration:underline}

    /* Expand/collapse arrows */
    summary{list-style:none;cursor:pointer;position:relative;padding-right:20px;color:#cfe1f7}
    summary::after{content:"\25BC"; /* ▼ */ position:absolute; right:0; top:0; font-size:12px; color:var(--muted)}
    details[open] > summary::after{content:"\25B2"; /* ▲ */}
    
  
    /* Header layout: back + title on the left */
    header.head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    header.head .left{display:flex;align-items:center;gap:12px}
    header .updated{display:none}

    /* Details summary arrows placed next to the label and vertically centered */
    details > summary{list-style:none;display:inline-flex;align-items:center;gap:6px;cursor:pointer;color:#cfe1f7}
    details > summary::-webkit-details-marker{display:none}
    details > summary::marker{content:""}
    details > summary::after{content:"▾";font-size:12px;color:var(--muted)}
    details[open] > summary::after{content:"▴"}

  
    /* Details summary arrows: bigger and vertically centered */
    details > summary {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: #cfe1f7;
      font-size: 14px;
      line-height: 1.3;
    }
    details > summary::-webkit-details-marker { display: none; }
    details > summary::marker { content: ""; }
    details > summary::after {
      content: "▾";
      display: inline-block;
      font-size: 1.05em;
      line-height: 1;
      transform: translateY(0.06em);
      color: var(--muted);
    }
    details[open] > summary::after {
      content: "▴";
    }

  
/* === Arrow fix: keep caret right next to the text and make it larger === */
details > summary {
  display: inline-flex !important;
  align-items: center !important;
  gap: 6px !important;
  padding-right: 0 !important; /* remove extra space used by previously right-aligned arrow */
}
details > summary::after {
  content: "▾";
  position: static !important;  /* cancel earlier absolute positioning */
  margin-left: 6px;
  font-size: 1.3em;             /* bigger than before */
  line-height: 1;
  transform: none !important;
  color: var(--muted);
}
details[open] > summary::after { content: "▴"; }
</style>
</head>
<body>
  <div class="wrap">
    <header class="head">
  <div class="left">
    <a class="back" href="overview.html">&larr; Back</a>
    <h1>bubbles</h1>
  </div>
</header>

    <!-- Top grid: Balance (with axes) / Win donut / Avg Win vs Loss -->
    <div class="grid">
      <!-- Balance card (includes sparkline WITH axes, contained) -->
      <section class="card" style="grid-column: span 5;">
        <div class="section-title">Balance</div>
        <div class="value" style="margin-bottom:6px">$7,259.79</div>
        <div id="balanceWrap"><canvas id="spark"></canvas></div>
      </section>

      <section class="card" style="grid-column: span 3;">
        <div class="section-title">Win Rate</div>
        <div class="donut">
          <div class="pie" style="--p: 38.89%;"></div>
          <div class="winrate-num">39.0%</div>
        </div>
        <div class="muted" style="margin-top:6px">wins vs losses (closed trades)</div>
      </section>

      
      <section class="card" style="grid-column: span 4;">
        <div class="section-title">Avg Win vs Avg Loss</div>
        <div class="bar-block">
          <div>
            <div class="muted">Average Win</div>
            <div class="hbar"><div class="fill win" style="width: 31.0%;"></div></div>
          </div>
          <div>
            <div class="muted">Average Loss</div>
            <div class="hbar"><div class="fill loss" style="width: 100.0%;"></div></div>
          </div>
          <div class="legend">
            <span><span class="chip" style="background:var(--green)"></span>Avg Win PNL %</span>
            <span><span class="chip" style="background:var(--red)"></span>Avg Loss PNL %</span>
            <span class="muted">3.1% vs -9.97%</span>
          </div>
        </div>
      </section>
    </div>

    <!-- Current Holdings -->
    <section class="card" style="margin-top:14px;">
      <div class="section-title">Current Holdings</div>
      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Qty</th>
            <th>% of Portfolio</th>
            <th>% Since Buy</th>
            <th>Current Value</th>
            <th>Value at Buy</th>
            <th>Buy Time</th> <!-- moved to last column -->
          </tr>
        </thead>
        <tbody id="holdingsBody"></tbody>
      </table>
      <div class="muted" style="margin-top:6px;">Values use the last known trade price per symbol unless live quotes are provided.</div>
    </section>

    <!-- Closed Trades (sells only) with buy/sell/hold times -->
    <section class="card" style="margin-top:14px;">
      <div class="section-title">Closed Trades</div>
      <table>
        <thead>
          <tr>
            <th>Buy Time</th>
            <th>Sell Time</th>
            <th>Hold Time</th>
            <th>Symbol</th>
            <th>Qty</th>
            <th>PNL %</th>
            <th>Price</th>
            <th>Balance After</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="closedBody"></tbody>
      </table>
    </section>

    <!-- Expandables (bottom, closed by default) -->
    
    <details style="margin-top:14px;">
      <summary>Portfolio Analysis</summary>
      <div class="inner"><pre>Rotate out of QCOM/BBIO/IDYA into stronger momentum pivots (STX, WDC, GNRC) to stay concentrated and fully invested.</pre></div>
    </details>
    

    
    <details style="margin-top:12px;">
      <summary>Prompt</summary>
      <div class="inner"><pre>You are an autonomous trading agent. Reply with STRICT JSON ONLY (no commentary, no code fences) following the schema documented below.

- Starting balance for a new/first run: 7288.5042.

- Include only NEW actions since 2025-10-28T14:30:20Z but ensure the final &#39;balance_after&#39; reflects current balance.

- Today you MUST honor CURRENT_PORTFOLIO_STATE (see below). You may SELL or HOLD existing positions, and you may BUY new ones only if AVAILABLE_CASH_USD is sufficient. NEVER spend more than AVAILABLE_CASH_USD and NEVER sell more than currently held (FIFO).

- You MUST output at least one action for the current day (first run included). Prefer buys from CANDIDATES_TODAY. If truly nothing qualifies, emit a single HOLD with &#39;balance_after&#39;.

- Allocate ~100% of capital across 1–4 positions using PRICES_TODAY (USD). Buys may be fractional shares (qty can be decimal, ≥ 4 places). For each buy, you may decide a dollar allocation and compute qty = allocation_dollars / price.

- For EVERY action you output (buy/sell/hold/rebalance), include &#39;balance_after&#39; = total portfolio value immediately after that action (cash + positions), valued using PRICES_TODAY.

- For SELL actions, compute &#39;pnl_pct&#39; from FIFO cost of prior BUYS when possible; keep it numeric (e.g., 0.0123 for +1.23), or null if not computable.

- Keep numbers raw (no % signs in &#39;pnl_pct&#39;).

- End-of-day you may hold 1–4 positions or cash if no setups qualify. Always output at least one action with &#39;balance_after&#39;.

PRICES_TODAY (USD):

ARCT=11.54, ATI=89.25, AVGX=63.39, AVY=186.28, AXGN=22.25, AXTI=7.07, BBIO=66.62, CMC=59.72, CSIQ=17.57, ELDN=4.25, F=13.26, FLEX=66.10, FLS=68.95, FORM=47.72, GNRC=180.86, HXL=72.79, IBM=313.09, IDYA=32.18, LBRT=18.94, LITE=214.28, LUMN=11.00, MIR=29.75, MMM=167.23, MP=74.11, NESR=14.10, PEGA=65.64, PI=235.83, PUMP=11.10, QCOM=178.67, QS=15.52, REMX=86.05, SNDK=204.36, STX=265.62, TNL=65.14, TTMI=63.53, UTHR=455.32, WDC=141.38, WGO=39.39

CANDIDATES_TODAY:

- gap_ups: PUMP, FLS, NESR
- pivots: PUMP, MIR, AXGN, FLS, FLEX, STX, UTHR, SNDK, LUMN, NESR, LBRT, WDC, FORM, AVGX, LITE, ELDN, GNRC, TTMI, AXTI, CSIQ
(total candidates: 23)

CURRENT_PORTFOLIO_STATE:

AVAILABLE_CASH_USD: 1.78
OPEN_POSITIONS:
- QCOM: qty=23.620000, ref_price=178.6700, first_buy_time=2025-10-27T14:30:07Z
- BBIO: qty=29.060000, ref_price=66.6200, first_buy_time=2025-10-27T14:30:08Z
- IDYA: qty=34.240000, ref_price=32.1800, first_buy_time=2025-10-27T14:30:09Z

Schema:

{
  &#34;model_name&#34;: &#34;&lt;string&gt;&#34;,
  &#34;universe&#34;: [&#34;SYM&#34;,&#34;...&#34;] | &#34;ALL&#34;,
  &#34;starting_balance&#34;: &lt;number&gt;,
  &#34;portfolio_analysis&#34;: &#34;&lt;string&gt;&#34;,
  &#34;trades&#34;: [
    {
      &#34;time&#34;: &#34;&lt;ISO8601Z&gt;&#34;,
      &#34;symbol&#34;: &#34;&lt;string&gt;&#34;,
      &#34;side&#34;: &#34;buy&#34;|&#34;sell&#34;|&#34;hold&#34;|&#34;rebalance&#34;,
      &#34;qty&#34;: &lt;number&gt;,
      &#34;price&#34;: &lt;number&gt;,
      &#34;pnl_pct&#34;: &lt;number|null&gt;,
      &#34;balance_after&#34;: &lt;number&gt;,
      &#34;notes&#34;: &#34;&lt;string&gt;&#34;
    }
  ]
}

=== STRATEGY CONTEXT ===

Objective
- You have an aggressive trading style. You research ALL stocks that qualify (market-wide) and must be in the best position every day.
- You take high risk approach and concentrate the entire portfolio in 1–4 stocks at all times.

Universe
- Scan the entire market for symbols that meet the rules below (not just a fixed watchlist). In JSON, set &#34;universe&#34; to &#34;ALL&#34; or a short representative list you actively monitored.

Daily mandate
- End each day holding 1–4 positions and be fully invested unless explicitly holding cash is optimal.
- If no new entries are taken, you must still rebalance or hold and OUTPUT an action reflecting the current balance (use a “notes” explanation).

Selection &amp; sizing
- Rank candidates by a composite of liquidity, momentum (multi-TF), and volatility-adjusted strength.
- Allocate across 1–4 names (e.g., 100% in 1 name, or 60/40, or 40/30/30, etc.). It’s OK to be 100% in one.
- Use whole-share quantities; reflect the resulting balance_after after each action.

Trade cadence
- If you’re carrying positions from yesterday, you must either (a) keep them and record a HOLD/REBAlANCE action, or (b) exit and rotate into better.
- Provide pnl_pct for closed positions when known; for same-day open entries, pnl_pct can be 0 until exit.

Risk &amp; constraints
- Favor large/mega-cap liquidity; avoid penny stocks.
- No options; equities/ETFs only.


Example HOLD:
{
  &#34;model_name&#34;: &#34;example&#34;,
  &#34;universe&#34;: &#34;ALL&#34;,
  &#34;starting_balance&#34;: 10000.0,
  &#34;portfolio_analysis&#34;: &#34;No new setups; preserving capital.&#34;,
  &#34;trades&#34;: [
    {&#34;time&#34;:&#34;2025-10-07T14:30:00Z&#34;,&#34;symbol&#34;:&#34;CASH&#34;,&#34;side&#34;:&#34;hold&#34;,&#34;qty&#34;:0,&#34;price&#34;:0,&#34;pnl_pct&#34;:null,&#34;balance_after&#34;:10000.0,&#34;notes&#34;:&#34;No change today; waiting for setups.&#34;}
  ]
}
</pre></div>
    </details>
    

    
    <details style="margin-top:12px;">
      <summary>Response</summary>
      <div class="inner"><pre>{
  &#34;model_name&#34;: &#34;AggressiveMomentumV1&#34;,
  &#34;universe&#34;: &#34;ALL&#34;,
  &#34;starting_balance&#34;: 7288.5042,
  &#34;portfolio_analysis&#34;: &#34;Rotate out of QCOM/BBIO/IDYA into stronger momentum pivots (STX, WDC, GNRC) to stay concentrated and fully invested.&#34;,
  &#34;trades&#34;: [
    {
      &#34;time&#34;: &#34;2025-10-29T14:35:01Z&#34;,
      &#34;symbol&#34;: &#34;QCOM&#34;,
      &#34;side&#34;: &#34;sell&#34;,
      &#34;qty&#34;: 23.62,
      &#34;price&#34;: 178.67,
      &#34;pnl_pct&#34;: -0.048,
      &#34;balance_after&#34;: 7259.7858,
      &#34;notes&#34;: &#34;Exit to rotate into higher-ranked pivots.&#34;
    },
    {
      &#34;time&#34;: &#34;2025-10-29T14:35:03Z&#34;,
      &#34;symbol&#34;: &#34;BBIO&#34;,
      &#34;side&#34;: &#34;sell&#34;,
      &#34;qty&#34;: 29.06,
      &#34;price&#34;: 66.62,
      &#34;pnl_pct&#34;: 0.0481,
      &#34;balance_after&#34;: 7259.7858,
      &#34;notes&#34;: &#34;Exit to redeploy into momentum leaders.&#34;
    },
    {
      &#34;time&#34;: &#34;2025-10-29T14:35:05Z&#34;,
      &#34;symbol&#34;: &#34;IDYA&#34;,
      &#34;side&#34;: &#34;sell&#34;,
      &#34;qty&#34;: 34.24,
      &#34;price&#34;: 32.18,
      &#34;pnl_pct&#34;: -0.0059,
      &#34;balance_after&#34;: 7259.7858,
      &#34;notes&#34;: &#34;Exit to consolidate into stronger setups.&#34;
    },
    {
      &#34;time&#34;: &#34;2025-10-29T14:35:30Z&#34;,
      &#34;symbol&#34;: &#34;STX&#34;,
      &#34;side&#34;: &#34;buy&#34;,
      &#34;qty&#34;: 12.299162,
      &#34;price&#34;: 265.62,
      &#34;pnl_pct&#34;: null,
      &#34;balance_after&#34;: 7259.7858,
      &#34;notes&#34;: &#34;Pivot/momentum leader; allocate ~45%.&#34;
    },
    {
      &#34;time&#34;: &#34;2025-10-29T14:35:32Z&#34;,
      &#34;symbol&#34;: &#34;WDC&#34;,
      &#34;side&#34;: &#34;buy&#34;,
      &#34;qty&#34;: 17.9723,
      &#34;price&#34;: 141.38,
      &#34;pnl_pct&#34;: null,
      &#34;balance_after&#34;: 7259.7858,
      &#34;notes&#34;: &#34;Complementary storage momentum; allocate ~35%.&#34;
    },
    {
      &#34;time&#34;: &#34;2025-10-29T14:35:34Z&#34;,
      &#34;symbol&#34;: &#34;GNRC&#34;,
      &#34;side&#34;: &#34;buy&#34;,
      &#34;qty&#34;: 8.028072,
      &#34;price&#34;: 180.86,
      &#34;pnl_pct&#34;: null,
      &#34;balance_after&#34;: 7259.7858,
      &#34;notes&#34;: &#34;Breakout participation; allocate ~20%.&#34;
    }
  ]
}</pre></div>
    </details>
    
  </div>

  <script>
    // server-provided data
    window.TRADES = [{"balance_after": "$7,259.79", "balance_after_num": 7259.7858, "balance_dir": 1, "notes": "Breakout participation; allocate ~20%.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "180.860000", "price_num": 180.86, "qty": "8.028072", "qty_num": 8.028072, "side": "buy", "symbol": "GNRC", "time": "2025-10-29T14:35:34Z"}, {"balance_after": "$7,259.79", "balance_after_num": 7259.7858, "balance_dir": 1, "notes": "Complementary storage momentum; allocate ~35%.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "141.380000", "price_num": 141.38, "qty": "17.9723", "qty_num": 17.9723, "side": "buy", "symbol": "WDC", "time": "2025-10-29T14:35:32Z"}, {"balance_after": "$7,259.79", "balance_after_num": 7259.7858, "balance_dir": 1, "notes": "Pivot/momentum leader; allocate ~45%.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "265.620000", "price_num": 265.62, "qty": "12.299162", "qty_num": 12.299162, "side": "buy", "symbol": "STX", "time": "2025-10-29T14:35:30Z"}, {"balance_after": "$7,259.79", "balance_after_num": 7259.7858, "balance_dir": -1, "notes": "Exit to consolidate into stronger setups.", "pnl_pct": "-0.59%", "pnl_pct_num": -0.0059, "price": "32.180000", "price_num": 32.18, "qty": "34.24", "qty_num": 34.24, "side": "sell", "symbol": "IDYA", "time": "2025-10-29T14:35:05Z"}, {"balance_after": "$7,259.79", "balance_after_num": 7259.7858, "balance_dir": 1, "notes": "Exit to redeploy into momentum leaders.", "pnl_pct": "4.81%", "pnl_pct_num": 0.0481, "price": "66.620000", "price_num": 66.62, "qty": "29.06", "qty_num": 29.06, "side": "sell", "symbol": "BBIO", "time": "2025-10-29T14:35:03Z"}, {"balance_after": "$7,259.79", "balance_after_num": 7259.7858, "balance_dir": -1, "notes": "Exit to rotate into higher-ranked pivots.", "pnl_pct": "-4.80%", "pnl_pct_num": -0.048, "price": "178.670000", "price_num": 178.67, "qty": "23.62", "qty_num": 23.62, "side": "sell", "symbol": "QCOM", "time": "2025-10-29T14:35:01Z"}, {"balance_after": "$7,288.50", "balance_after_num": 7288.5042, "balance_dir": 1, "notes": "Hold existing positions; insufficient cash for new entries.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "0.000000", "price_num": 0.0, "qty": "0", "qty_num": 0.0, "side": "hold", "symbol": "CASH", "time": "2025-10-28T14:30:20Z"}, {"balance_after": "$7,390.19", "balance_after_num": 7390.189425, "balance_dir": 1, "notes": "Momentum/relative strength; ~15% allocation.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "32.370000", "price_num": 32.37, "qty": "34.24", "qty_num": 34.24, "side": "buy", "symbol": "IDYA", "time": "2025-10-27T14:30:09Z"}, {"balance_after": "$7,390.19", "balance_after_num": 7390.189425, "balance_dir": 1, "notes": "Momentum pivot; ~25% allocation.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "63.560000", "price_num": 63.56, "qty": "29.06", "qty_num": 29.06, "side": "buy", "symbol": "BBIO", "time": "2025-10-27T14:30:08Z"}, {"balance_after": "$7,390.19", "balance_after_num": 7390.189425, "balance_dir": 1, "notes": "Top-ranked gap/momentum; ~60% allocation.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "187.680000", "price_num": 187.68, "qty": "23.62", "qty_num": 23.62, "side": "buy", "symbol": "QCOM", "time": "2025-10-27T14:30:07Z"}, {"balance_after": "$7,390.19", "balance_after_num": 7390.189425, "balance_dir": -1, "notes": "Rotate capital to stronger setups.", "pnl_pct": "-4.19%", "pnl_pct_num": -0.0419, "price": "13.260000", "price_num": 13.26, "qty": "214.8305", "qty_num": 214.8305, "side": "sell", "symbol": "F", "time": "2025-10-27T14:30:06Z"}, {"balance_after": "$7,390.19", "balance_after_num": 7390.189425, "balance_dir": 1, "notes": "Exit non-candidate to free capital.", "pnl_pct": "1.83%", "pnl_pct_num": 0.0183, "price": "313.090000", "price_num": 313.09, "qty": "14.5055", "qty_num": 14.5055, "side": "sell", "symbol": "IBM", "time": "2025-10-27T14:30:05Z"}, {"balance_after": "$7,433.12", "balance_after_num": 7433.11585, "balance_dir": 1, "notes": "Pivot candidate; deploy remaining cash without exceeding available.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "13.840000", "price_num": 13.84, "qty": "214.8305", "qty_num": 214.8305, "side": "buy", "symbol": "F", "time": "2025-10-24T14:30:04Z"}, {"balance_after": "$7,433.12", "balance_after_num": 7433.11585, "balance_dir": 1, "notes": "Pivot candidate; large-cap momentum; ~60% allocation.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "307.460000", "price_num": 307.46, "qty": "14.5055", "qty_num": 14.5055, "side": "buy", "symbol": "IBM", "time": "2025-10-24T14:30:03Z"}, {"balance_after": "$7,433.12", "balance_after_num": 7433.11585, "balance_dir": -1, "notes": "Exit to free capital; small FIFO loss.", "pnl_pct": "-2.21%", "pnl_pct_num": -0.0221, "price": "235.830000", "price_num": 235.83, "qty": "7.68", "qty_num": 7.68, "side": "sell", "symbol": "PI", "time": "2025-10-24T14:30:02Z"}, {"balance_after": "$7,433.12", "balance_after_num": 7433.11585, "balance_dir": 1, "notes": "Exit as part of rotation; locking small gain per FIFO.", "pnl_pct": "2.59%", "pnl_pct_num": 0.0259, "price": "72.790000", "price_num": 72.79, "qty": "36.58", "qty_num": 36.58, "side": "sell", "symbol": "HXL", "time": "2025-10-24T14:30:01Z"}, {"balance_after": "$7,433.12", "balance_after_num": 7433.11585, "balance_dir": 1, "notes": "Exit to rotate into stronger candidates.", "pnl_pct": "0.00%", "pnl_pct_num": 0.0, "price": "89.250000", "price_num": 89.25, "qty": "33.129", "qty_num": 33.129, "side": "sell", "symbol": "ATI", "time": "2025-10-24T14:30:00Z"}, {"balance_after": "$7,416.77", "balance_after_num": 7416.766535, "balance_dir": 1, "notes": "High-momentum pivot name; ~25% allocation; small cash buffer retained.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "241.170000", "price_num": 241.17, "qty": "7.68", "qty_num": 7.68, "side": "buy", "symbol": "PI", "time": "2025-10-23T14:32:10Z"}, {"balance_after": "$7,416.77", "balance_after_num": 7416.766535, "balance_dir": 1, "notes": "Gap-up + pivot confluence; ~35% allocation.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "70.950000", "price_num": 70.95, "qty": "36.58", "qty_num": 36.58, "side": "buy", "symbol": "HXL", "time": "2025-10-23T14:32:05Z"}, {"balance_after": "$7,416.77", "balance_after_num": 7416.766535, "balance_dir": 1, "notes": "Pivot leader with strong momentum; ~40% allocation.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "89.550000", "price_num": 89.55, "qty": "33.129", "qty_num": 33.129, "side": "buy", "symbol": "ATI", "time": "2025-10-23T14:32:00Z"}, {"balance_after": "$7,416.77", "balance_after_num": 7416.766535, "balance_dir": 1, "notes": "Exit to focus on higher-ranked setups.", "pnl_pct": "0.01%", "pnl_pct_num": 7.62e-05, "price": "65.640000", "price_num": 65.64, "qty": "34.1775", "qty_num": 34.1775, "side": "sell", "symbol": "PEGA", "time": "2025-10-23T14:31:15Z"}, {"balance_after": "$7,416.77", "balance_after_num": 7416.766535, "balance_dir": -1, "notes": "Exit laggard; capital rotation.", "pnl_pct": "-6.82%", "pnl_pct_num": -0.0682, "price": "65.140000", "price_num": 65.14, "qty": "21.377", "qty_num": 21.377, "side": "sell", "symbol": "TNL", "time": "2025-10-23T14:31:10Z"}, {"balance_after": "$7,416.77", "balance_after_num": 7416.766535, "balance_dir": -1, "notes": "Exit to reallocate to momentum leaders.", "pnl_pct": "-3.08%", "pnl_pct_num": -0.0308, "price": "39.390000", "price_num": 39.39, "qty": "36.7733", "qty_num": 36.7733, "side": "sell", "symbol": "WGO", "time": "2025-10-23T14:31:05Z"}, {"balance_after": "$7,416.77", "balance_after_num": 7416.766535, "balance_dir": 1, "notes": "Exit to rotate into stronger candidates.", "pnl_pct": "4.04%", "pnl_pct_num": 0.0404, "price": "186.280000", "price_num": 186.28, "qty": "12.5206", "qty_num": 12.5206, "side": "sell", "symbol": "AVY", "time": "2025-10-23T14:31:00Z"}, {"balance_after": "$7,472.34", "balance_after_num": 7472.34476, "balance_dir": 1, "notes": "Candidate (pivot); complements basket; avoids penny names.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "69.910000", "price_num": 69.91, "qty": "21.377", "qty_num": 21.377, "side": "buy", "symbol": "TNL", "time": "2025-10-22T15:03:13Z"}, {"balance_after": "$7,472.34", "balance_after_num": 7472.34476, "balance_dir": 1, "notes": "Candidate (gap_up + pivot); fresh strength.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "40.640000", "price_num": 40.64, "qty": "36.7733", "qty_num": 36.7733, "side": "buy", "symbol": "WGO", "time": "2025-10-22T15:03:09Z"}, {"balance_after": "$7,472.34", "balance_after_num": 7472.34476, "balance_dir": 1, "notes": "Candidate (pivot); momentum continuation setup.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "65.590000", "price_num": 65.59, "qty": "34.1775", "qty_num": 34.1775, "side": "buy", "symbol": "PEGA", "time": "2025-10-22T15:03:05Z"}, {"balance_after": "$7,472.34", "balance_after_num": 7472.34476, "balance_dir": 1, "notes": "Candidate (pivot); large-cap, strong relative strength.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "179.040000", "price_num": 179.04, "qty": "12.5206", "qty_num": 12.5206, "side": "buy", "symbol": "AVY", "time": "2025-10-22T15:03:00Z"}, {"balance_after": "$7,472.34", "balance_after_num": 7472.34476, "balance_dir": 1, "notes": "Exit to consolidate into today\u2019s setups.", "pnl_pct": "0.00%", "pnl_pct_num": 0.0, "price": "11.540000", "price_num": 11.54, "qty": "115.279", "qty_num": 115.279, "side": "sell", "symbol": "ARCT", "time": "2025-10-22T15:02:19Z"}, {"balance_after": "$7,472.34", "balance_after_num": 7472.34476, "balance_dir": 1, "notes": "Exit to reallocate into momentum names.", "pnl_pct": "0.00%", "pnl_pct_num": 0.0, "price": "59.720000", "price_num": 59.72, "qty": "43.0275", "qty_num": 43.0275, "side": "sell", "symbol": "CMC", "time": "2025-10-22T15:02:15Z"}, {"balance_after": "$7,472.34", "balance_after_num": 7472.34476, "balance_dir": 1, "notes": "Exit to rotate into stronger candidates.", "pnl_pct": "0.00%", "pnl_pct_num": 0.0, "price": "167.230000", "price_num": 167.23, "qty": "21.36", "qty_num": 21.36, "side": "sell", "symbol": "MMM", "time": "2025-10-22T15:02:11Z"}, {"balance_after": "$8,899.54", "balance_after_num": 8899.538415, "balance_dir": 1, "notes": "No changes; retaining MMM, CMC, ARCT. Portfolio remains ~100% allocated using current prices.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "0.000000", "price_num": 0.0, "qty": "0", "qty_num": 0.0, "side": "hold", "symbol": "CASH", "time": "2025-10-22T14:46:00Z"}, {"balance_after": "$8,899.54", "balance_after_num": 8899.538415, "balance_dir": 1, "notes": "Hold existing positions (MMM, CMC, ARCT); fully invested and aligned with candidate list; no rebalance today.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "0.000000", "price_num": 0.0, "qty": "0", "qty_num": 0.0, "side": "hold", "symbol": "CASH", "time": "2025-10-21T14:45:01Z"}, {"balance_after": "$8,899.54", "balance_after_num": 8899.538247, "balance_dir": 1, "notes": "Momentum biotech from candidate list to complete diversified 3-name allocation.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "23.160000", "price_num": 23.16, "qty": "115.279", "qty_num": 115.279, "side": "buy", "symbol": "ARCT", "time": "2025-10-21T14:31:06Z"}, {"balance_after": "$8,899.54", "balance_after_num": 8899.538247, "balance_dir": 1, "notes": "Pivot candidate; strong relative strength.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "62.050000", "price_num": 62.05, "qty": "43.0275", "qty_num": 43.0275, "side": "buy", "symbol": "CMC", "time": "2025-10-21T14:31:05Z"}, {"balance_after": "$8,899.54", "balance_after_num": 8899.538247, "balance_dir": 1, "notes": "Pivot candidate; large-cap anchor allocation.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "166.640000", "price_num": 166.64, "qty": "21.36", "qty_num": 21.36, "side": "buy", "symbol": "MMM", "time": "2025-10-21T14:31:04Z"}, {"balance_after": "$8,899.54", "balance_after_num": 8899.538247, "balance_dir": -1, "notes": "Exit to concentrate capital in today\u2019s leaders.", "pnl_pct": "-24.19%", "pnl_pct_num": -0.2419, "price": "74.110000", "price_num": 74.11, "qty": "40.9165", "qty_num": 40.9165, "side": "sell", "symbol": "MP", "time": "2025-10-21T14:31:02Z"}, {"balance_after": "$8,899.54", "balance_after_num": 8899.538247, "balance_dir": -1, "notes": "Exit to rotate into stronger candidates.", "pnl_pct": "-9.50%", "pnl_pct_num": -0.095, "price": "15.520000", "price_num": 15.52, "qty": "204.0816", "qty_num": 204.0816, "side": "sell", "symbol": "QS", "time": "2025-10-21T14:31:00Z"}, {"balance_after": "$10,000.00", "balance_after_num": 10000.0, "balance_dir": 1, "notes": "Third entry; ~25% allocation via ETF for diversified exposure to rare earth miners.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "79.680000", "price_num": 79.68, "qty": "31.3755", "qty_num": 31.3755, "side": "buy", "symbol": "REMX", "time": "2025-10-13T14:32:00Z"}, {"balance_after": "$10,299.58", "balance_after_num": 10299.58, "balance_dir": 1, "notes": "Third entry; ~25% allocation via ETF for diversified exposure to rare earth miners.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "86.050000", "price_num": 86.05, "qty": "31.3755", "qty_num": 31.3755, "side": "sell", "symbol": "REMX", "time": "2025-10-13T14:32:00Z"}, {"balance_after": "$10,000.00", "balance_after_num": 10000.0, "balance_dir": 1, "notes": "Second entry; ~35% allocation to strong pivot candidate with high liquidity.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "17.150000", "price_num": 17.15, "qty": "204.0816", "qty_num": 204.0816, "side": "buy", "symbol": "QS", "time": "2025-10-13T14:31:00Z"}, {"balance_after": "$10,000.00", "balance_after_num": 10000.0, "balance_dir": 1, "notes": "Initial entry; ~40% allocation to liquid leader in rare earths.", "pnl_pct": "\u2014", "pnl_pct_num": 0.0, "price": "97.760000", "price_num": 97.76, "qty": "40.9165", "qty_num": 40.9165, "side": "buy", "symbol": "MP", "time": "2025-10-13T14:30:00Z"}];
    const BAL = {"t":["2025-10-13T14:30:00Z","2025-10-13T14:31:00Z","2025-10-13T14:32:00Z","2025-10-13T14:32:00Z","2025-10-21T14:31:00Z","2025-10-21T14:31:02Z","2025-10-21T14:31:04Z","2025-10-21T14:31:05Z","2025-10-21T14:31:06Z","2025-10-21T14:45:01Z","2025-10-22T14:46:00Z","2025-10-22T15:02:11Z","2025-10-22T15:02:15Z","2025-10-22T15:02:19Z","2025-10-22T15:03:00Z","2025-10-22T15:03:05Z","2025-10-22T15:03:09Z","2025-10-22T15:03:13Z","2025-10-23T14:31:00Z","2025-10-23T14:31:05Z","2025-10-23T14:31:10Z","2025-10-23T14:31:15Z","2025-10-23T14:32:00Z","2025-10-23T14:32:05Z","2025-10-23T14:32:10Z","2025-10-24T14:30:00Z","2025-10-24T14:30:01Z","2025-10-24T14:30:02Z","2025-10-24T14:30:03Z","2025-10-24T14:30:04Z","2025-10-27T14:30:05Z","2025-10-27T14:30:06Z","2025-10-27T14:30:07Z","2025-10-27T14:30:08Z","2025-10-27T14:30:09Z","2025-10-28T14:30:20Z","2025-10-29T14:35:01Z","2025-10-29T14:35:03Z","2025-10-29T14:35:05Z","2025-10-29T14:35:30Z","2025-10-29T14:35:32Z","2025-10-29T14:35:34Z"],"v":[10000.0,10000.0,10000.0,10299.58,8899.538247,8899.538247,8899.538247,8899.538247,8899.538247,8899.538415,8899.538415,7472.34476,7472.34476,7472.34476,7472.34476,7472.34476,7472.34476,7472.34476,7416.766535,7416.766535,7416.766535,7416.766535,7416.766535,7416.766535,7416.766535,7433.11585,7433.11585,7433.11585,7433.11585,7433.11585,7390.189425,7390.189425,7390.189425,7390.189425,7390.189425,7288.5042,7259.7858,7259.7858,7259.7858,7259.7858,7259.7858,7259.7858]};

    const fmtMoney = v => (v==null ? "—" : "$"+Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}));
    const fmtPct   = v => (v==null ? "—" : (v*100).toFixed(2)+"%");
    const fmtQty   = v => (v==null ? "—" : Number(v).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:6}));
    const fmtTime  = iso => {
      if(!iso) return "—";
      const d = new Date(iso);
      const MM = String(d.getMonth()+1).padStart(2,'0');
      const DD = String(d.getDate()).padStart(2,'0');
      const YY = String(d.getFullYear()).slice(-2);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${MM}:${DD}:${YY} ${hh}:${mm}`;
    };
    const fmtHold  = (ms) => {
      if(!ms || ms<0) return "—";
      const d = Math.floor(ms/86400000);
      ms %= 86400000;
      const h = Math.floor(ms/3600000);
      ms %= 3600000;
      const m = Math.floor(ms/60000);
      return (d?`${d}d `:"")+`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    };

    // Build holdings & closed sells (FIFO with buy-time capture)
    function buildPortfolio(trades){
      const chron = [...trades].sort((a,b)=> (a.time||"").localeCompare(b.time||""));
      const lots = {};      // sym -> [{qty, price, time}]
      const lastPrice = {}; // sym -> last known trade price
      const closed = [];

      for(const t of chron){
        const side = String(t.side||"").toLowerCase();
        const sym = t.symbol, qty = Number(t.qty||0), price = Number(t.price||0);
        if(sym){ if(price>0) lastPrice[sym] = price; else lastPrice[sym] = lastPrice[sym]||0; }

        if(side === "buy" || side === "rebalance"){
          if(!lots[sym]) lots[sym] = [];
          if(qty>0 && price>0) lots[sym].push({qty, price, time: t.time});
        } else if (side === "sell"){
          let remaining = qty, cost = 0, proceeds = (price||0) * qty;
          let firstBuyTime = null;
          if(!lots[sym]) lots[sym] = [];
          while(remaining > 0 && lots[sym].length){
            const lot = lots[sym][0];
            const take = Math.min(remaining, lot.qty);
            cost += take * lot.price;
            if(!firstBuyTime) firstBuyTime = lot.time;
            lot.qty -= take;
            remaining -= take;
            if(lot.qty <= 0) lots[sym].shift();
          }
          const sellTime = t.time;
          const pnlPct = cost>0 ? (proceeds - cost)/cost : (t.pnl_pct_num ?? null);
          closed.push({
            buy_time:firstBuyTime, sell_time:sellTime, hold_ms:(firstBuyTime && sellTime) ? (new Date(sellTime)-new Date(firstBuyTime)) : null,
            symbol:sym, qty, price, balance_after:t.balance_after, notes:t.notes||"", pnl_pct:pnlPct
          });
        }
      }

      // Open holdings + invested value & buy time (earliest remaining lot)
      const holdings = [];
      let investedValue = 0;
      for(const sym of Object.keys(lots)){
        let qty=0, cost=0, firstBuyTime=null;
        for(const lot of lots[sym]){
          if(!firstBuyTime) firstBuyTime = lot.time;
          qty += lot.qty;
          cost += lot.qty*lot.price;
        }
        if(qty>0){
          const price = lastPrice[sym] || 0;
          const cur = qty*price;
          investedValue += cur;
          const gainPct = cost>0 ? (cur - cost)/cost : 0;
          holdings.push({symbol:sym, qty, price, cost, cur, gainPct, buy_time:firstBuyTime});
        }
      }
      holdings.sort((a,b)=> b.cur - a.cur);

      // Portfolio value from latest balance series point (fallback to investedValue)
      const series = (BAL && BAL.v) ? BAL.v : [];
      const latestBal = series.length ? Number(series[series.length-1]) : null;
      const portfolioValue = (latestBal!=null ? latestBal : investedValue);
      const cash = Math.max(0, portfolioValue - investedValue);

      // Allocation %
      for(const h of holdings){ h.allocPct = portfolioValue>0 ? h.cur/portfolioValue : 0; }

      closed.sort((a,b)=> (b.sell_time||"").localeCompare(a.sell_time||""));
      return {holdings, closed, cash, portfolioValue};
    }

    (function(){
      const data = buildPortfolio(window.TRADES || []);

      // Holdings + CASH row
      const hb = document.getElementById("holdingsBody");
      let rows = "";
      if(data.holdings.length){
        rows += data.holdings.map(h=>{
          const alloc=(h.allocPct*100).toFixed(2)+"%";
          const gain=(h.gainPct*100).toFixed(2)+"%";
          const cls = h.gainPct>=0 ? "pct up" : "pct down";
          return `<tr>
            <td>${h.symbol}</td>
            <td>${fmtQty(h.qty)}</td>
            <td>${alloc}</td>
            <td class="${cls}">${gain}</td>
            <td>${fmtMoney(h.cur)}</td>
            <td>${fmtMoney(h.cost)}</td>
            <td>${fmtTime(h.buy_time)}</td>
          </tr>`;
        }).join("");
      } else {
        rows += `<tr><td colspan="7" class="note">No open positions.</td></tr>`;
      }

      // CASH row (always show)
      const cashAlloc = data.portfolioValue>0 ? ((data.cash/data.portfolioValue)*100).toFixed(2)+"%" : "—";
      rows += `<tr>
        <td>CASH</td>
        <td>—</td>
        <td>${cashAlloc}</td>
        <td>—</td>
        <td>${fmtMoney(data.cash)}</td>
        <td>—</td>
        <td>—</td>
      </tr>`;
      hb.innerHTML = rows;

      // Closed trades
      const cb = document.getElementById("closedBody");
      cb.innerHTML = data.closed.length
        ? data.closed.map(t=>{
            const pnlCls = (t.pnl_pct||0) >= 0 ? "pct up" : "pct down";
            return `<tr>
              <td>${fmtTime(t.buy_time)}</td>
              <td>${fmtTime(t.sell_time)}</td>
              <td>${fmtHold(t.hold_ms)}</td>
              <td>${t.symbol}</td>
              <td>${fmtQty(t.qty)}</td>
              <td class="${pnlCls}">${fmtPct(t.pnl_pct)}</td>
              <td>${fmtMoney(t.price)}</td>
              <td>${fmtMoney(t.balance_after)}</td>
              <td class="note">${t.notes||""}</td>
            </tr>`;
          }).join("")
        : `<tr><td colspan="9" class="note">No closed trades yet.</td></tr>`;

      // Balance chart with axes inside the card
      (function drawChart(){
        const cvs = document.getElementById("spark");
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const wrap = document.getElementById("balanceWrap");
        const W = Math.floor(wrap.clientWidth * dpr), H = Math.floor(160 * dpr);
        cvs.width = W; cvs.height = H;

        const ctx = cvs.getContext("2d");
        const xs = BAL.t || [], ys = BAL.v || [];
        if(!ctx || xs.length===0 || ys.length===0) return;

        // scale helpers
        const padL=50*dpr, padR=10*dpr, padT=15*dpr, padB=25*dpr;
        const minY = Math.min(...ys), maxY = Math.max(...ys), spanY = Math.max(1e-9, maxY-minY);
        const n = ys.length;

        ctx.clearRect(0,0,W,H);
        ctx.save();
        ctx.translate(0.5,0.5);

        // axes
        ctx.strokeStyle = "rgba(255,255,255,.25)";
        ctx.lineWidth = 1;
        // y-axis
        ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL, H-padB); ctx.stroke();
        // x-axis
        ctx.beginPath(); ctx.moveTo(padL, H-padB); ctx.lineTo(W-padR, H-padB); ctx.stroke();

        // y ticks (min, mid, max)
        ctx.fillStyle = "rgba(255,255,255,.6)";
        ctx.font = `${12*dpr}px system-ui, sans-serif`;
        const yVals = [minY, minY + spanY/2, maxY];
        yVals.forEach((v,i)=>{
          const y = H - padB - (H-padT-padB)*((v-minY)/spanY);
          ctx.strokeStyle = "rgba(255,255,255,.08)";
          ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W-padR, y); ctx.stroke();
          ctx.fillText("$"+v.toFixed(0), 6*dpr, y+4*dpr);
        });

        // line
        ctx.strokeStyle = "#7dd3fc";
        ctx.lineWidth = 2*dpr; ctx.beginPath();
        for(let i=0;i<n;i++){
          const x = padL + (W-padL-padR) * (i/(n-1));
          const y = H - padB - (H-padT-padB) * ((ys[i]-minY)/spanY);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();

        // x labels (first, mid, last)
        const labels = [0, Math.floor((n-1)/2), n-1];
        ctx.fillStyle = "rgba(255,255,255,.6)";
        labels.forEach(idx=>{
          const dd = new Date(xs[idx]);
          const lab = `${String(dd.getMonth()+1).padStart(2,"0")}:${String(dd.getDate()).padStart(2,"0")}`;
          const x = padL + (W-padL-padR) * (idx/(n-1));
          ctx.fillText(lab, x-12*dpr, H-7*dpr);
        });

        ctx.restore();
      })();
    })();
  </script>
</body>
</html>