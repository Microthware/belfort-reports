<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Public Portfolios</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b0f14;--card:#11161d;--muted:#9bb1c8;--text:#e8f0fa;--green:#16a34a;--red:#dc2626;--border:#223142}
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1280px;margin:28px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{font-size:22px;margin:0}
    .updated{color:var(--muted);font-size:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
    table{width:100%;border-collapse:collapse}
    thead th{text-align:left;font-weight:600;font-size:13px;color:var(--muted);padding:10px 12px;background:rgba(255,255,255,.02);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px;white-space:nowrap;vertical-align:middle}
    a{color:#9ecbff;text-decoration:none}
    a:hover{text-decoration:underline}
    .pct.up{color:var(--green);font-weight:600}
    .pct.down{color:var(--red);font-weight:600}
    details{margin-bottom:16px}
    summary{list-style:none;display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:700;color:#cfe1f7}
    summary::-webkit-details-marker{display:none}
    summary::marker{content:""}
    summary .arrow{font-size:14px;color:var(--muted)}
    details[open] > summary .arrow{transform:rotate(180deg)}

    .topgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:16px;margin:8px 0 14px;align-items:start}
    .piewrap{display:flex;gap:16px;align-items:center}
    .pie{width:320px;height:280px;position:relative}
    .legend{display:flex;flex-direction:column;gap:6px}
    .legend-item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .swatch{width:10px;height:10px;border-radius:2px;display:inline-block}
    .holdings{border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .holdings th,.holdings td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:13px}
    .holdings thead th{background:rgba(255,255,255,.02);font-weight:700;color:var(--muted)}

    .trades-scroller{max-height: 440px; overflow-y: auto; border:1px solid var(--border); border-radius:10px;}
    .muted{color:var(--muted);font-size:12px}
    .footer-updated{position:fixed;right:12px;bottom:10px;color:var(--muted);font-size:12px}
  
    .section-heading{
      font-size:14px;
      font-weight:700;
      margin:0 0 8px;
      letter-spacing:.3px;
      color:#cfe1f7;
      padding: 10px 5px 5px 10px;
    }

/* Responsive: let holdings drop below the pie on small screens and keep the pie scalable */
.piewrap{flex-wrap:wrap}
.pie{width:100%;max-width:280px;height:auto;position:relative}
.pie svg{width:100%;height:auto;max-width:360px}

/* Keep holdings table readable */
.holdings table{table-layout:auto;width:100%}

/* Stack layout earlier on narrower widths */
@media (max-width: 980px){
  .piewrap{flex-direction:column;align-items:flex-start}
  .pie{max-width:320px}
}
@media (max-width: 420px){
  .topgrid{grid-template-columns:1fr}
  .pie{max-width:280px}
}

</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:12px">
        <a class="back" href="overview.html" style="color:#9ecbff;text-decoration:none">&larr; Back</a>
        <h1>Public Portfolios</h1>
      </div>
      <div class="updated">Updated {{ gen_time }}</div>
    </header>

    {% if hp_stocks %}
    <section class="card" style="margin-bottom:14px">
      <div class="section-heading">High-Profile Stocks (Manual CSV)</div>
      <div style="max-height:420px; overflow:auto; border:1px solid var(--border); border-radius:10px;">
        <table>
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Date</th>
              <th>Entry</th>
              <th>Current</th>
              <th>PNL</th>
              <th>Gap Ups</th>
              <th>Info</th>
            </tr>
          </thead>
          <tbody>
            {% for r in hp_stocks %}
            <tr>
              <td><img src="{{ r.logo_url }}" alt="" style="width:16px;height:16px;border-radius:50%;vertical-align:-3px;margin-right:6px"><strong>{{ r.symbol }}</strong></td>
              <td class="muted">{{ r.date }}</td>
              <td>{{ ('$' ~ ('%.2f'|format(r.entry_price))) if r.entry_price else '—' }}</td>
              <td>{{ ('$' ~ ('%.2f'|format(r.current_price))) if r.current_price else '—' }}</td>
              <td>
                {% if r.pnl_float is not none %}
                  {% set p = r.pnl_float %}
                  <span class="{{ 'pct up' if p >= 0 else 'pct down' }}">{{ ('%.2f'|format(p*100)) }}%</span>
                {% else %}—{% endif %}
              </td>
              <td>{{ r.gap_ups }}</td>
              <td class="muted">{{ r.info }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:6px">Source: <code>history/hp-stocks.csv</code>. PNL refreshes when the portfolios job runs.</div>
    </section>
    {% endif %}

    <section class="card">
      {% for sec in sections %}
      <details {{ 'open' if loop.first else '' }}>
        <summary><span class="arrow">▾</span> {{ sec.name }}</summary>

        <!-- TOP: donut + small holdings table -->
        <div class="topgrid">
          <div>
            <div class="piewrap">
              <div class="pie">
                <svg id="pie-{{ sec.slug }}" viewBox="0 0 360 320" width="320" height="280"></svg>
                <svg id="pielabels-{{ sec.slug }}" viewBox="0 0 360 320" width="320" height="280" style="position:absolute;left:0;top:0"></svg>
                <svg id="piemasks-{{ sec.slug }}" viewBox="0 0 360 320" width="0" height="0" style="position:absolute; left:-9999px; top:-9999px"></svg>
              </div>
              <div class="legend" id="legend-{{ sec.slug }}"></div>
            </div>
            <div class="muted">Percentages are educated estimates based on public data.</div>
            <div class="muted">The current holdings are certain but their percentages are estimates based on limited public data. Weights use lifecycle inventory (stock + non‑exercised call exposure). Option “shares” are shown as share‑equivalents.</div>
          </div>

          <div class="holdings">
            <div class="section-heading">Current Holdings</div>
            <table>
              <thead>
                <tr>
                  <th>Ticker</th>
                  <th>% of Portfolio</th>
                  <th>Change Since Buy</th>
                </tr>
              </thead>
              <tbody id="holdings-{{ sec.slug }}"></tbody>
            </table>
          </div>
        </div>

        <!-- TRADES -->
        <div style="margin:8px 0 6px" class="muted">Total trades: {{ sec.rows|length }}</div>
        <div class="trades-scroller">
          <table>
            <thead>
              <tr>
                <th>Published</th>
                <th>Traded</th>
                <th>Ticker</th>
                <th>Issuer</th>
                <th>Type</th>
                <th>Entry Price</th>
                <th>Shares</th>
                <th>Since Trade %</th>
                <th>SPY %</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody id="tb-{{ sec.slug }}"></tbody>
          </table>
        </div>
      </details>
      {% endfor %}
      <div style="margin-top:8px" class="muted">Sources: PTRs & third-party aggregators. Informational only.</div>
    </section>
  </div>

  <div class="footer-updated">Updated {{ gen_time }}</div>

  <script>
    const SECTIONS = {{ sections_json | safe }};
    const ANGLE_OFFSET = Math.PI / 2;

    function pctText(n){
      if(!isFinite(n)) return '—';
      const p = n*100;
      return (p < 0.1 && p > 0) ? '<0.1%' : p.toFixed(2)+'%';
    }
    function pctNode(v){
      if(v==null || v==='') return '—';
      const n = Number(v);
      if(!isFinite(n)) return '—';
      const cls = n>=0 ? 'pct up' : 'pct down';
      return `<span class="${cls}">${(n*100).toFixed(2)}%</span>`;
    }

    // Compute shares for display (handles option rows where only '50 call options' was captured)
    function computeDisplayShares(r){
      const instr = String(r.instrument||'').toLowerCase();
      const isEx = ['true','1','yes'].includes(String(r.is_exercise||'').toLowerCase());
      if(instr === 'option' && !isEx){
        const c = Number(r.contracts);
        if(Number.isFinite(c) && c > 0) return String(Math.round(c * 100)) + " (equiv)";
        const s = Number(r.shares);
        if(Number.isFinite(s) && s > 0 && s <= 500) return String(Math.round(s * 100)) + " (equiv)";
      }
      const raw = (r.shares==null || String(r.shares).trim()==='') ? '—' : String(r.shares);
      return raw;
    }

    function resolveLabelCollisions(labels, minGap){
      labels.sort((a,b)=>a.y-b.y);
      for(let i=1;i<labels.length;i++){
        const prev = labels[i-1];
        const cur = labels[i];
        if(cur.y - prev.y < minGap){
          const shift = (minGap - (cur.y - prev.y));
          cur.y += shift;
        }
      }
      return labels;
    }

    function renderHoldings(sec){
      const list = (sec.holdings || []);
      const tbody = document.querySelector('#holdings-'+sec.slug);
      const legend = document.querySelector('#legend-'+sec.slug);
      const pie = document.querySelector('#pie-'+sec.slug);
      const labelsLayer = document.querySelector('#pielabels-'+sec.slug);
      const masks = document.querySelector('#piemasks-'+sec.slug);
      if(!tbody || !legend || !pie || !labelsLayer || !masks) return;

      tbody.innerHTML = list.map(x => `
        <tr>
          <td><strong>${x.ticker}</strong></td>
          <td>${pctText(x.weight)}</td>
          <td>${pctNode(x.change)}</td>
        </tr>
      `).join("");

      const palette = ['#0021A5','#FA4616','#0077c0','#22884C','#D50A0A','#FCD006','#4B2A91','#6B21A8','#0EA5E9','#FF7900','#A855F7','#CA8A04','#34302B','#B1BABf'];
      legend.innerHTML = list.map((x,i)=>`
        <div class="legend-item"><span class="swatch" style="background:${palette[i%palette.length]}"></span> ${x.ticker} — ${pctText(x.weight)}</div>
      `).join("");

      pie.innerHTML = ''; labelsLayer.innerHTML = ''; masks.innerHTML = '';
      if(!list.length) return;
      const cx=180, cy=160, r=105;
      let start = 0;
      const pendingLabels = [];
      for(let i=0;i<list.length;i++){
        const x = list[i];
        const frac = Math.max(0, x.weight || 0);
        const end = start + frac*2*Math.PI;
        const large = (end-start) > Math.PI ? 1 : 0;

        const sA = start + ANGLE_OFFSET, eA = end + ANGLE_OFFSET;
        const x1 = cx + r*Math.cos(sA), y1 = cy + r*Math.sin(sA);
        const x2 = cx + r*Math.cos(eA), y2 = cy + r*Math.sin(eA);
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`);
        path.setAttribute('fill', palette[i%palette.length]);
        pie.appendChild(path);

        const mid = (start+end)/2 + ANGLE_OFFSET;
        const imgR = 10;
        const lx = cx + (r+32)*Math.cos(mid);
        const ly = cy + (r+32)*Math.sin(mid);
        pendingLabels.push({i, mid, x: lx, y: ly, imgR, sideRight: Math.cos(mid) >= 0});
        start = end;
      }


      // donut hole
      (function(){
        const card = getComputedStyle(document.documentElement).getPropertyValue('--card').trim() || '#11161d';
        const border = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#223142';
        const hole = document.createElementNS('http://www.w3.org/2000/svg','circle');
        hole.setAttribute('cx', cx);
        hole.setAttribute('cy', cy);
        hole.setAttribute('r', String(Math.round(r*0.58)));
        hole.setAttribute('fill', card);
        hole.setAttribute('stroke', border);
        hole.setAttribute('stroke-width', '1');
        pie.appendChild(hole);
      })();
    
      // resolve collisions & draw labels
      const minGap = 14;
      const left = pendingLabels.filter(L=>!L.sideRight);
      const right = pendingLabels.filter(L=>L.sideRight);
      const resolved = resolveLabelCollisions(left, minGap).concat(resolveLabelCollisions(right, minGap));
      for(const L of resolved){
        const maskId = `clip-${sec.slug}-${L.i}`;
        const clip = document.createElementNS('http://www.w3.org/2000/svg','clipPath');
        clip.setAttribute('id', maskId);
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', L.x); c.setAttribute('cy', L.y); c.setAttribute('r', 10);
        clip.appendChild(c);
        masks.appendChild(clip);

        const img = document.createElementNS('http://www.w3.org/2000/svg','image');
        const row = list[L.i];
        img.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href', row.logo_url || '');
        img.setAttribute('href', row.logo_url || '');
        img.setAttribute('x', L.x - 10);
        img.setAttribute('y', L.y - 10);
        img.setAttribute('width', 20);
        img.setAttribute('height', 20);
        img.setAttribute('clip-path', `url(#${maskId})`);
        labelsLayer.appendChild(img);

        const tx = L.x + (Math.cos(L.mid) >= 0 ? 14 : -14);
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', tx);
        text.setAttribute('y', L.y);
        text.setAttribute('fill', '#cfe1f7');
        text.setAttribute('font-size', '11');
        text.setAttribute('text-anchor', (Math.cos(L.mid)>=0? 'start':'end'));
        text.setAttribute('dominant-baseline', 'middle');
        text.textContent = list[L.i].ticker;
        labelsLayer.appendChild(text);
      }
    }

    function rowHtml(r){
      const src = r.pdf_url ? `<a href="${r.pdf_url}" target="_blank" rel="noopener">PTR PDF</a>` : (r.detail_url ? `<a href="${r.detail_url}" target="_blank" rel="noopener">Detail</a>` : "—");
      const sharesTxt = computeDisplayShares(r);
      return `<tr>
        <td>${r.published_date || "—"}</td>
        <td>${r.traded_date || "—"}</td>
        <td>${r.ticker || "—"}</td>
        <td>${r.issuer || "—"}</td>
        <td>${(r.type||"").toUpperCase() || "—"}</td>
        <td>${r.entry_price ? '$' + Number(r.entry_price).toFixed(2) : '—'}</td>
        <td>${sharesTxt}</td>
        <td>${(r.since_trade_pct!=null && r.since_trade_pct!=='') ? (Number(r.since_trade_pct)>=0 ? '<span class="pct up">'+(Number(r.since_trade_pct)*100).toFixed(2)+'%</span>' : '<span class="pct down">'+(Number(r.since_trade_pct)*100).toFixed(2)+'%</span>') : '—'}</td>
        <td>${(r.since_trade_spy_pct!=null && r.since_trade_spy_pct!=='') ? (Number(r.since_trade_spy_pct)>=0 ? '<span class="pct up">'+(Number(r.since_trade_spy_pct)*100).toFixed(2)+'%</span>' : '<span class="pct down">'+(Number(r.since_trade_spy_pct)*100).toFixed(2)+'%</span>') : '—'}</td>
        <td>${src}</td>
      </tr>`;
    }

    // Render all sections
    for(const sec of SECTIONS){
      const tbody = document.querySelector("#tb-"+sec.slug);
      if(tbody){ tbody.innerHTML = (sec.rows || []).map(rowHtml).join(""); }
      renderHoldings(sec);
    }
  </script>
</body>
</html>